var mergetags=function(g){"use strict";class l{#e=[];#s=[];#t=new Map;static normalizeGroups(e){return Array.isArray(e)?e.map(t=>{const s=t?.menu??t?.items;return Array.isArray(s)?{title:String(t?.title??""),menu:l.normalizeGroups(s)}:typeof t?.value<"u"?{title:String(t?.title??t.value),value:String(t.value)}:null}).filter(Boolean):[]}static flatten(e,t=[]){for(const s of e)Array.isArray(s?.menu)?l.flatten(s.menu,t):typeof s?.value<"u"&&t.push({title:String(s.title??s.value),value:String(s.value)});return t}setTokens(e){this.#e=l.normalizeGroups(e??[]),this.#r()}refreshFromOptions(e){const t=e?.getList?.()??[];this.#e=l.normalizeGroups(t),this.#r()}#r(){this.#s=l.flatten(this.#e,[]),this.#t=new Map(this.#s.map(e=>[e.value,e]))}getGroups(){return this.#e}getFlat(){return this.#s}getByValue(e){return this.#t.get(String(e))}hasValue(e){return this.#t.has(String(e))}values(){return this.#t.keys()}}class p{constructor(e){this.options=e,this.tokens=new l}refreshFromOptions=()=>{this.tokens.refreshFromOptions(this.options)};setTokens=e=>{this.tokens.setTokens(e)}}const u=o=>String(o).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=o=>String(o).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");class m{constructor(e){this.options=e}getPrefix(){return this.options.getPrefix()}getSuffix(){return this.options.getSuffix()}getTokenClass(){return this.options.getTokenClass()}getDelimiterRegex(e="g"){const t=u(this.getPrefix()),s=u(this.getSuffix());return new RegExp(`${t}([\\s\\S]*?)${s}`,e)}wrap(e){return`${this.getPrefix()}${String(e)}${this.getSuffix()}`}}class k{constructor(e,t,s){this.editor=e,this.options=t,this.format=s}#e(e){return this.options.getDisplayMode()==="value"?e.value:e.title||e.value}createTokenElement(e,t){const s=this.editor.getDoc(),r=s.createElement("span");r.setAttribute("class",this.options.getTokenClass()),r.setAttribute("data-mt-val",e.value),r.setAttribute("contenteditable","false");const i=s.createElement("span");i.setAttribute("class",this.options.getBraceClass()),i.textContent=this.format.getPrefix();const a=s.createTextNode(this.#e(e)),n=s.createElement("span");return n.setAttribute("class",this.options.getBraceClass()),n.textContent=this.format.getSuffix(),r.append(i,a,n),r}toSpanHTML(e,t){const s=this.options.getTokenClass(),r=this.options.getBraceClass(),i=f(e.value);return`<span class="${s}" data-mt-val="${i}" contenteditable="false"><span class="${r}">${this.editor.dom.encode(this.format.getPrefix())}</span>${this.editor.dom.encode(this.#e(e))}<span class="${r}">${this.editor.dom.encode(this.format.getSuffix())}</span></span>`}}class v{constructor(e,t,s,r,i){this.editor=e,this.options=t,this.renderer=s,this.tokens=r,this.format=i}replaceTokensWithDelimiters(e){const t=this.editor.getDoc(),s=t.createElement("div");return s.innerHTML=e,s.querySelectorAll(`span.${this.options.getTokenClass()}[data-mt-val]`).forEach(r=>{const i=r.getAttribute("data-mt-val")||"";r.replaceWith(t.createTextNode(this.format.wrap(i)))}),s.innerHTML}replaceDelimitersWithTokens(e){const t=this.format.getDelimiterRegex("g");return e.replace(t,(s,r)=>{const i=this.tokens.getByValue(String(r));return i?this.renderer.toSpanHTML(i):s})}}class y{constructor(e,t,s,r,i){this.editor=e,this.options=t,this.renderer=s,this.tokens=r,this.format=i}clearActiveTokens(){const e=this.editor.getBody(),t=this.options.getTokenClass(),s=this.options.getActiveClass();e.querySelectorAll(`span.${t}.${s}`).forEach(r=>r.classList.remove(s))}activateToken(e){this.clearActiveTokens(),e.classList.add(this.options.getActiveClass()),this.editor.selection.select(e),this.editor.selection.collapse(!1)}insertTag(e){this.editor.undoManager.transact(()=>{const t=this.renderer.createTokenElement(e);this.editor.selection.setNode(t),this.options.highlightOnInsert()&&this.activateToken(t)})}insertByValue(e){const t=this.tokens.getByValue(e);t&&this.insertTag(t)}getTokenAncestor(e){const t=this.options.getTokenClass();return this.editor.dom.getParent(e,s=>s&&s.nodeType===1&&this.editor.dom.hasClass(s,t))}upgradeRawUnderCaret(){const t=this.editor.selection?.getRng()?.startContainer,s=t?.nodeType===Node.TEXT_NODE?t:[...t?.childNodes??[]].find(h=>h.nodeType===Node.TEXT_NODE);if(!s)return!1;const r=this.format.getDelimiterRegex(),i=s.nodeValue,a=r.exec(i);if(!a)return!1;const n=String(a[1]),c=this.tokens.getByValue(n);return c?(this.editor.undoManager.transact(()=>{this.replaceMatchedTextWithToken(s,i,a,c)}),!0):!1}replaceMatchedTextWithToken(e,t,s,r){const i=t.slice(0,s.index),a=t.slice(s.index+s[0].length),n=e.parentNode,c=this.renderer.createTokenElement(r),h=this.editor.getDoc();i&&n.insertBefore(h.createTextNode(i),e),n.insertBefore(c,e),a&&n.insertBefore(h.createTextNode(a),e),n.removeChild(e),this.activateToken(c)}onBodyClick(e){const t=this.getTokenAncestor(e.target);if(t){e.preventDefault(),this.activateToken(t);return}this.upgradeRawUnderCaret()||this.clearActiveTokens()}}class T{constructor(e,t){this.editor=e,this.options=t,this.state=new p(t),this.format=new m(t),this.renderer=new k(e,t,this.format),this.transformer=new v(e,t,this.renderer,this.state.tokens,this.format),this.interactions=new y(e,t,this.renderer,this.state.tokens,this.format),this.state.refreshFromOptions()}installSchemaAndStyles(){this.editor.schema.addValidElements("span[class|contenteditable|data-mt-val]");const e=this.options.getTokenClass(),t=this.options.getBraceClass(),s=this.options.getActiveClass();this.editor.contentStyles.push(`.${e} .${t}{color:#16a34a;font-weight:400;}`,`.${e}.${s}{outline:3px solid rgba(0,125,126,.75);}`)}getMenuItems(){return this.#e(this.state.tokens.getGroups())}insertByValue(e){this.interactions.insertByValue(e)}setTokens(e){this.state.setTokens(e)}autocomplete(e,t){const s=(e||"").toLowerCase(),r=this.state.tokens.getFlat(),i=s?r.filter(n=>(n.title||n.value).toLowerCase().includes(s)||n.value.toLowerCase().includes(s)):r.slice(),a=Math.min(typeof t=="number"?t:10,i.length);return i.slice(0,a).map(n=>({text:n.title||n.value,value:n.value}))}replaceTokensWithDelimiters(e){return this.transformer.replaceTokensWithDelimiters(e)}replaceDelimitersWithTokens(e){return this.transformer.replaceDelimitersWithTokens(e)}onBodyClick(e){this.interactions.onBodyClick(e)}#e(e){return!Array.isArray(e)||!e.length?[{type:"menuitem",text:"No tags",enabled:!1}]:e.map(t=>Array.isArray(t.menu)?{type:"nestedmenuitem",text:t.title||"",getSubmenuItems:()=>this.#e(t.menu)}:{type:"menuitem",text:t.title||t.value,onAction:()=>this.interactions.insertTag({title:t.title||t.value,value:t.value})})}}class C{constructor(e,t){this.editor=e,this.core=t,this._bodyClickHandler=null}bindAll(){this.editor.on("PreInit",()=>{this.core.installSchemaAndStyles()}),this.editor.on("GetContent",t=>{t.content=this.core.replaceTokensWithDelimiters(t.content)});const e=t=>{t.content=this.core.replaceDelimitersWithTokens(t.content)};this.editor.on("BeforeSetContent",e),this.editor.on("PastePreProcess",e),this.editor.on("init",()=>{const t=this.editor.getBody();this._bodyClickHandler=s=>this.core.onBodyClick(s),t.addEventListener("click",this._bodyClickHandler)}),this.editor.on("remove",()=>{const t=this.editor.getBody();this._bodyClickHandler&&t.removeEventListener("click",this._bodyClickHandler)})}}class x{constructor(e,t){this.editor=e,this.core=t}mount(){this.editor.ui.registry.addIcon("mergetags",'<svg width="24" height="24" focusable="false"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5a2 2 0 0 1 1.6.8L21 12l-4.4 6.2a2 2 0 0 1-1.6.8h-3v-2h3l3.5-5L15 7H5v3H3V7c0-1.1.9-2 2-2h10Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0-1 1v2H3a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2H7v-2c0-.6-.4-1-1-1Z"></path></svg>'),this.editor.ui.registry.addMenuButton("mergetags",{icon:"mergetags",tooltip:"Insert merge tag",fetch:t=>t(this.core.getMenuItems())}),this.editor.ui.registry.addNestedMenuItem("mergetags-menu",{text:"Merge tags",getSubmenuItems:()=>this.core.getMenuItems()});const e={trigger:"{{",minChars:0,columns:1,matches:()=>!0,fetch:(t,s)=>Promise.resolve(this.core.autocomplete(t,s)),onAction:(t,s,r)=>{s&&this.editor.selection.setRng(s),this.core.insertByValue(String(r)),t.hide()}};this.editor.ui.registry.addAutocompleter("mergetags",e)}}class b{constructor(e){this.editor=e}register(){const{register:e}=this.editor.options;e("mergetags_list",{processor:"array",default:[]}),e("mergetags_prefix",{processor:"string",default:"{{"}),e("mergetags_suffix",{processor:"string",default:"}}"}),e("mergetags_token_class",{processor:"string",default:"mce-mergetag"}),e("mergetags_brace_class",{processor:"string",default:"mce-mergetag-affix"}),e("mergetags_highlight_class",{processor:"string",default:"mt-active"}),e("mergetags_show_braces",{processor:"boolean",default:!0}),e("mergetags_highlight_on_insert",{processor:"boolean",default:!0}),e("mergetags_display",{processor:"string",default:"value"}),e("mergetags_keep_unknown",{processor:"boolean",default:!0})}getPrefix(){return this.editor.options.get("mergetags_prefix")}getSuffix(){return this.editor.options.get("mergetags_suffix")}getTokenClass(){return this.editor.options.get("mergetags_token_class")}getBraceClass(){return this.editor.options.get("mergetags_brace_class")}getActiveClass(){return this.editor.options.get("mergetags_highlight_class")}getDisplayMode(){return this.editor.options.get("mergetags_display")}highlightOnInsert(){return!!this.editor.options.get("mergetags_highlight_on_insert")}keepUnknown(){return!!this.editor.options.get("mergetags_keep_unknown")}getList(){return this.editor.options.get("mergetags_list")}}const d=o=>{o.PluginManager.add("mergetags",e=>{const t=new b(e);t.register();const s=new T(e,t),r=new x(e,s),i=new C(e,s);return r.mount(),i.bindAll(),{getMetadata:()=>({name:"Merge Tags (Self-hosted)",version:"1.0.0"})}})};return(()=>{const o=typeof window<"u"&&window.tinymce?window.tinymce:null;o&&d(o)})(),g.registerMergetags=d,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),g}({});
