var mergetags=function(u){"use strict";const d=a=>String(a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),k=a=>String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");class c{constructor(t){this.options=t,this.groupedTokens=[],this.flatTokens=[],this.valueMap=new Map,this.uidCounter=0,this._didInitPass=!1}static normalizeGroups(t){return Array.isArray(t)?t.map(e=>{const s=e.menu||e.items;return Array.isArray(s)?{title:String(e.title||""),menu:c.normalizeGroups(s)}:typeof e.value<"u"?{title:String(e.title||e.value),value:String(e.value)}:null}).filter(Boolean):[]}static flatten(t,e=[]){for(const s of t)Array.isArray(s.menu)?c.flatten(s.menu,e):typeof s.value<"u"&&e.push({title:String(s.title||s.value),value:String(s.value)});return e}rebuildIndex(){this.flatTokens=c.flatten(this.groupedTokens,[]),this.valueMap=new Map(this.flatTokens.map(t=>[t.value,t]))}refreshFromOptions=()=>{const t=this.options.getList();this.groupedTokens=c.normalizeGroups(t),this.rebuildIndex()};setTokens=t=>{this.groupedTokens=c.normalizeGroups(t||[]),this.rebuildIndex()};nextUid=()=>(this.uidCounter+=1,this.uidCounter.toString(36));get didInitPass(){return this._didInitPass}set didInitPass(t){this._didInitPass=!!t}}class T{constructor(t,e){this.editor=t,this.options=e,this.state=new c(e),this.state.refreshFromOptions(),this.editor.on("PreInit",()=>{this.state.refreshFromOptions(),this.installSchemaAndStyles()}),this.editor.on("init",()=>{setTimeout(this.transformInitialContentOnce,0)}),this.editor.on("LoadContent",this.transformInitialContentOnce)}installSchemaAndStyles=()=>{this.editor.schema.addValidElements("span[class|contenteditable|data-mt-val|data-mt-uid]");const t=this.options.getTokenClass(),e=this.options.getBraceClass(),s=this.options.getActiveClass();this.editor.contentStyles.push(`.${t} .${e}{color:#16a34a;font-weight:400;}`,`.${t}.${s}{outline:3px solid rgba(0,125,126,.75);}`)};refreshTokensFromOptions=()=>{this.state.refreshFromOptions()};retokenizeEditorContent=()=>{const t=this.editor.getContent({format:"html"}),e=this.replaceDelimitersWithTokens(t);this.editor.setContent(e),this.migrateOldTokens()};getMenuItems=()=>this.#e(this.state.groupedTokens);insertByValue=t=>{const e=this.state.valueMap.get(String(t));this.insertTag(e)};setTokens=t=>{this.state.setTokens(t)};autocomplete=(t,e)=>{const s=(t||"").toLowerCase(),i=this.state.flatTokens,n=s?i.filter(o=>(o.title||o.value).toLowerCase().includes(s)||o.value.toLowerCase().includes(s)):i.slice(),r=Math.min(typeof e=="number"?e:this.options.getMaxSuggestions(),n.length);return n.slice(0,r).map(o=>({text:o.title||o.value,value:o.value}))};getTagValues=()=>Array.from(this.state.valueMap.keys());#t(t){return this.options.getDisplayMode()==="value"?t.value:t.title||t.value}createTokenElement(t,e){const s=this.editor.getDoc(),i=s.createElement("span");i.setAttribute("class",this.options.getTokenClass()),i.setAttribute("data-mt-val",t.value),i.setAttribute("data-mt-uid",String(e)),i.setAttribute("contenteditable","false");const n=s.createElement("span");n.setAttribute("class",this.options.getBraceClass()),n.textContent=this.options.getPrefix();const r=s.createTextNode(this.#t(t)),o=s.createElement("span");return o.setAttribute("class",this.options.getBraceClass()),o.textContent=this.options.getSuffix(),i.append(n,r,o),i}toSpanHTML(t,e){const s=this.options.getTokenClass(),i=this.options.getBraceClass(),n=k(t.value),r=e?` data-mt-uid="${String(e)}"`:"";return`<span class="${s}" data-mt-val="${n}"${r} contenteditable="false"><span class="${i}">${this.editor.dom.encode(this.options.getPrefix())}</span>${this.editor.dom.encode(this.#t(t))}<span class="${i}">${this.editor.dom.encode(this.options.getSuffix())}</span></span>`}clearActiveTokens(){const t=this.editor.getBody(),e=this.options.getTokenClass(),s=this.options.getActiveClass();t.querySelectorAll(`span.${e}.${s}`).forEach(i=>i.classList.remove(s))}activateToken(t){this.clearActiveTokens(),t.classList.add(this.options.getActiveClass()),this.editor.selection.select(t),this.editor.selection.collapse(!1)}insertTag=t=>{this.editor.undoManager.transact(()=>{const e=this.state.nextUid(),s=this.createTokenElement(t,e);this.editor.selection.setNode(s),this.options.highlightOnInsert()&&this.activateToken(s)})};#e(t){return!Array.isArray(t)||!t.length?[{type:"menuitem",text:"No tags",enabled:!1}]:t.map(e=>Array.isArray(e.menu)?{type:"nestedmenuitem",text:e.title||"",getSubmenuItems:()=>this.#e(e.menu)}:{type:"menuitem",text:e.title||e.value,onAction:()=>this.insertTag({title:e.title||e.value,value:e.value})})}replaceTokensWithDelimiters(t){const e=document.implementation.createHTMLDocument(""),s=e.createElement("div");s.innerHTML=t;const i=this.options.getTokenClass(),n=this.options.getPrefix(),r=this.options.getSuffix();return s.querySelectorAll(`span.${i}[data-mt-val]`).forEach(o=>{const l=o.getAttribute("data-mt-val")||"";o.replaceWith(e.createTextNode(n+l+r))}),s.innerHTML}replaceDelimitersWithTokens(t){const e=this.options.getPrefix(),s=this.options.getSuffix(),i=new RegExp(`${d(e)}([\\s\\S]*?)${d(s)}`,"g");return t.replace(i,(n,r)=>{const o=this.state.valueMap.get(String(r));return o?this.toSpanHTML(o):n})}upgradeRawUnderCaret=()=>{const e=this.editor.selection?.getRng()?.startContainer,s=e?.nodeType===Node.TEXT_NODE?e:[...e?.childNodes??[]].find(h=>h.nodeType===Node.TEXT_NODE);if(!s)return!1;const i=this.options.getPrefix(),n=this.options.getSuffix(),r=new RegExp(`${d(i)}([\\s\\S]*?)${d(n)}`),o=s.nodeValue,l=r.exec(o);if(!l)return!1;const A=String(l[1]),m=this.state.valueMap.get(A);return m?(this.editor.undoManager.transact(()=>{const h=o.slice(0,l.index),f=o.slice(l.index+l[0].length),g=s.parentNode,S=this.state.nextUid(),v=this.createTokenElement(m,S);h&&g.insertBefore(this.editor.getDoc().createTextNode(h),s),g.insertBefore(v,s),f&&g.insertBefore(this.editor.getDoc().createTextNode(f),s),g.removeChild(s),this.activateToken(v)}),!0):!1};migrateOldTokens=()=>{const t=this.editor.getBody();if(!t)return;const e=this.options.getTokenClass(),s=this.options.getBraceClass();t.querySelectorAll(`span.${e}[data-mt-val]`).forEach(i=>{if(i.querySelector(`span.${s}`))return;const n=i.getAttribute("data-mt-val")||"",r=this.state.valueMap.get(n)||{title:n,value:n},o=this.state.nextUid(),l=this.createTokenElement(r,o);i.replaceWith(l)})};transformInitialContentOnce=()=>{if(this.state.didInitPass)return;this.state.didInitPass=!0;const t=this.editor.getContent({format:"html"}),e=this.replaceDelimitersWithTokens(t);e!==t&&this.editor.setContent(e),this.migrateOldTokens()};getTokenAncestor(t){const e=this.options.getTokenClass();return this.editor.dom.getParent(t,s=>s&&s.nodeType===1&&this.editor.dom.hasClass(s,e))}onBodyClick=t=>{const e=this.options.getTokenClass(),s=this.editor.dom.getParent(t.target,i=>i&&i.nodeType===1&&this.editor.dom.hasClass(i,e));if(s){t.preventDefault(),this.activateToken(s);return}this.upgradeRawUnderCaret()||this.clearActiveTokens()}}class C{constructor(t,e){this.editor=t,this.core=e,this._bodyClickHandler=null}bindAll(){this.editor.on("PreInit",this.core.refreshTokensFromOptions),this.editor.on("PreInit",this.core.installSchemaAndStyles),this.editor.on("GetContent",e=>{e.content=this.core.replaceTokensWithDelimiters(e.content)});const t=e=>{e.content=this.core.replaceDelimitersWithTokens(e.content)};this.editor.on("BeforeSetContent",t),this.editor.on("PastePreProcess",t),this.editor.on("keydown",e=>{const s=this.editor.selection?.getNode(),i=this.core.getTokenAncestor(s);i&&(e.preventDefault(),this.editor.undoManager.transact(()=>i.remove()))}),this.editor.on("NodeChange",e=>{const s=this.core.getTokenAncestor(e.element);s&&(this.editor.selection.select(s),this.editor.selection.collapse(!1))}),this.editor.on("init",()=>{const e=this.editor.getBody();this._bodyClickHandler=s=>this.core.onBodyClick(s),e.addEventListener("click",this._bodyClickHandler),setTimeout(this.core.transformInitialContentOnce,0)}),this.editor.on("LoadContent",this.core.transformInitialContentOnce),this.editor.on("remove",()=>{const e=this.editor.getBody();this._bodyClickHandler&&e.removeEventListener("click",this._bodyClickHandler)})}}class y{constructor(t,e){this.editor=t,this.core=e}register(){this.editor.addCommand("mergetags:insert",(t,e)=>{const s=e&&(e.value||e);this.core.insertByValue(String(s))}),this.editor.addCommand("mergetags:setTokens",(t,e)=>{this.core.setTokens(e),this.core.retokenizeEditorContent()})}}class b{constructor(t,e){this.editor=t,this.core=e}mount(){this.editor.ui.registry.addIcon("mergetags",'<svg width="24" height="24" focusable="false"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5a2 2 0 0 1 1.6.8L21 12l-4.4 6.2a2 2 0 0 1-1.6.8h-3v-2h3l3.5-5L15 7H5v3H3V7c0-1.1.9-2 2-2h10Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0-1 1v2H3a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2H7v-2c0-.6-.4-1-1-1Z"></path></svg>'),this.editor.ui.registry.addMenuButton("mergetags",{icon:"mergetags",tooltip:"Insert merge tag",fetch:e=>e(this.core.getMenuItems())}),this.editor.ui.registry.addNestedMenuItem("mergetags-menu",{text:"Merge tags",getSubmenuItems:()=>this.core.getMenuItems()});const t={trigger:"{{",minChars:0,columns:1,matches:()=>!0,fetch:(e,s)=>Promise.resolve(this.core.autocomplete(e,s)),onAction:(e,s,i)=>{s&&this.editor.selection.setRng(s),this.core.insertByValue(String(i)),e.hide()}};this.editor.ui.registry.addAutocompleter("mergetags",t)}}class x{constructor(t){this.editor=t}register(){const{register:t}=this.editor.options;t("mergetags_list",{processor:"array",default:[]}),t("mergetags_prefix",{processor:"string",default:"{{"}),t("mergetags_suffix",{processor:"string",default:"}}"}),t("mergetags_token_class",{processor:"string",default:"mce-mergetag"}),t("mergetags_brace_class",{processor:"string",default:"mce-mergetag-affix"}),t("mergetags_highlight_class",{processor:"string",default:"mt-active"}),t("mergetags_show_braces",{processor:"boolean",default:!0}),t("mergetags_highlight_on_insert",{processor:"boolean",default:!0}),t("mergetags_display",{processor:"string",default:"value"}),t("mergetags_keep_unknown",{processor:"boolean",default:!0})}getPrefix(){return this.editor.options.get("mergetags_prefix")}getSuffix(){return this.editor.options.get("mergetags_suffix")}getTokenClass(){return this.editor.options.get("mergetags_token_class")}getBraceClass(){return this.editor.options.get("mergetags_brace_class")}getActiveClass(){return this.editor.options.get("mergetags_highlight_class")}getDisplayMode(){return this.editor.options.get("mergetags_display")}highlightOnInsert(){return!!this.editor.options.get("mergetags_highlight_on_insert")}keepUnknown(){return!!this.editor.options.get("mergetags_keep_unknown")}getList(){return this.editor.options.get("mergetags_list")}}const p=a=>{a.PluginManager.add("mergetags",t=>{const e=new x(t);e.register();const s=new T(t,e),i=new b(t,s),n=new C(t,s),r=new y(t,s);return i.mount(),n.bindAll(),r.register(),{getMetadata:()=>({name:"Merge Tags (Self-hosted)",version:"1.0.0"})}})};return(()=>{const a=typeof window<"u"&&window.tinymce?window.tinymce:null;a&&p(a)})(),u.registerMergetags=p,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),u}({});
