var mergetags=function(h){"use strict";class l{#e=[];#t=[];#s=new Map;static normalizeGroups(e){return Array.isArray(e)?e.map(t=>{const s=t?.menu??t?.items;return Array.isArray(s)?{title:String(t?.title??""),menu:l.normalizeGroups(s)}:typeof t?.value<"u"?{title:String(t?.title??t.value),value:String(t.value)}:null}).filter(Boolean):[]}static flatten(e,t=[]){for(const s of e)Array.isArray(s?.menu)?l.flatten(s.menu,t):typeof s?.value<"u"&&t.push({title:String(s.title??s.value),value:String(s.value)});return t}setTokens(e){this.#e=l.normalizeGroups(e??[]),this.#r()}refreshFromOptions(e){this.setTokens(e?.getList?.())}#r(){this.#t=l.flatten(this.#e,[]),this.#s=new Map(this.#t.map(e=>[e.value,e]))}autocomplete(e,t){const s=(e||"").toLowerCase(),r=this.#t,i=s?r.filter(o=>(o.title||o.value).toLowerCase().includes(s)||o.value.toLowerCase().includes(s)):r.slice(),a=Math.min(typeof t=="number"?t:10,i.length);return i.slice(0,a).map(o=>({text:o.title||o.value,value:o.value}))}getGroups(){return this.#e}getByValue(e){return this.#s.get(String(e))}}class d{constructor(e){this.options=e,this.tokens=new l}refreshFromOptions=()=>{this.tokens.refreshFromOptions(this.options)};setTokens=e=>{this.tokens.setTokens(e)}}const g=n=>String(n).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");class p{constructor(e,t){this.editor=e,this.displayMode=t.getDisplayMode(),this.tokenClass=t.getTokenClass(),this.braceClass=t.getBraceClass(),this.prefix=t.getPrefix(),this.suffix=t.getSuffix()}#e(e){return this.displayMode==="value"?e.value:e.title||e.value}createTokenElement(e){const t=document.createElement("span");t.setAttribute("class",this.tokenClass),t.setAttribute("data-mt-val",e.value),t.setAttribute("contenteditable","false");const s=document.createElement("span");s.setAttribute("class",this.braceClass),s.textContent=this.prefix;const r=document.createTextNode(this.#e(e)),i=document.createElement("span");return i.setAttribute("class",this.braceClass),i.textContent=this.suffix,t.append(s,r,i),t}toSpanHTML(e,t){return this.createTokenElement(e,t).outerHTML}getDelimiterRegex(e="g"){const t=g(this.prefix),s=g(this.suffix);return new RegExp(`${t}([\\s\\S]*?)${s}`,e)}wrap(e){return`${this.prefix}${String(e)}${this.suffix}`}}class m{constructor(e,t,s,r){this.editor=e,this.tokenClass=t.getTokenClass(),this.renderer=s,this.tokens=r}replaceTokensWithDelimiters(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll(`span.${this.tokenClass}[data-mt-val]`).forEach(s=>{const r=s.getAttribute("data-mt-val")||"";s.replaceWith(document.createTextNode(this.renderer.wrap(r)))}),t.innerHTML}replaceDelimitersWithTokens(e){const t=this.renderer.getDelimiterRegex("g");return e.replace(t,(s,r)=>{const i=this.tokens.getByValue(String(r));return i?this.renderer.toSpanHTML(i):s})}}class f{constructor(e,t,s,r){this.editor=e,this.options=t,this.renderer=s,this.tokens=r}clearActiveTokens(){const e=this.editor.getBody(),t=this.options.getTokenClass(),s=this.options.getActiveClass();e.querySelectorAll(`span.${t}.${s}`).forEach(r=>r.classList.remove(s))}activateToken(e){this.clearActiveTokens(),e.classList.add(this.options.getActiveClass()),this.editor.selection.select(e),this.editor.selection.collapse(!1)}insertTag(e){this.editor.undoManager.transact(()=>{const t=this.renderer.createTokenElement(e);this.editor.selection.setNode(t),this.options.highlightOnInsert()&&this.activateToken(t)})}insertByValue(e){const t=this.tokens.getByValue(e);t&&this.insertTag(t)}getTokenAncestor(e){const t=this.options.getTokenClass();return this.editor.dom.getParent(e,s=>s&&s.nodeType===1&&this.editor.dom.hasClass(s,t))}upgradeRawUnderCaret(){const t=this.editor.selection?.getRng()?.startContainer,s=t?.nodeType===Node.TEXT_NODE?t:[...t?.childNodes??[]].find(C=>C.nodeType===Node.TEXT_NODE);if(!s)return!1;const r=this.renderer.getDelimiterRegex(),i=s.nodeValue,a=r.exec(i);if(!a)return!1;const o=String(a[1]),c=this.tokens.getByValue(o);return c?(this.editor.undoManager.transact(()=>{this.replaceMatchedTextWithToken(s,i,a,c)}),!0):!1}replaceMatchedTextWithToken(e,t,s,r){const i=t.slice(0,s.index),a=t.slice(s.index+s[0].length),o=e.parentNode,c=this.renderer.createTokenElement(r);i&&o.insertBefore(document.createTextNode(i),e),o.insertBefore(c,e),a&&o.insertBefore(document.createTextNode(a),e),o.removeChild(e),this.activateToken(c)}onBodyClick(e){const t=this.getTokenAncestor(e.target);if(t){e.preventDefault(),this.activateToken(t);return}this.upgradeRawUnderCaret()||this.clearActiveTokens()}}class k{constructor(e,t){this.editor=e,this.options=t,this.state=new d(t),this.renderer=new p(e,t),this.transformer=new m(e,t,this.renderer,this.state.tokens),this.interactions=new f(e,t,this.renderer,this.state.tokens),this.state.refreshFromOptions()}installSchemaAndStyles(){this.editor.schema.addValidElements("span[class|contenteditable|data-mt-val]");const e=this.options.getTokenClass(),t=this.options.getBraceClass(),s=this.options.getActiveClass();this.editor.contentStyles.push(`.${e} .${t}{color:#16a34a;font-weight:400;}`,`.${e}.${s}{outline:3px solid rgba(0,125,126,.75);}`)}getMenuItems(){return this.#e(this.state.tokens.getGroups())}insertByValue(e){this.interactions.insertByValue(e)}setTokens(e){this.state.setTokens(e)}replaceTokensWithDelimiters(e){return this.transformer.replaceTokensWithDelimiters(e)}replaceDelimitersWithTokens(e){return this.transformer.replaceDelimitersWithTokens(e)}onBodyClick(e){this.interactions.onBodyClick(e)}#e(e){return!Array.isArray(e)||!e.length?[{type:"menuitem",text:"No tags",enabled:!1}]:e.map(t=>Array.isArray(t.menu)?{type:"nestedmenuitem",text:t.title||"",getSubmenuItems:()=>this.#e(t.menu)}:{type:"menuitem",text:t.title||t.value,onAction:()=>this.interactions.insertTag({title:t.title||t.value,value:t.value})})}}class v{constructor(e,t){this.editor=e,this.core=t,this._bodyClickHandler=null}bindAll(){this.editor.on("PreInit",()=>{this.core.installSchemaAndStyles()}),this.editor.on("GetContent",t=>{t.content=this.core.replaceTokensWithDelimiters(t.content)});const e=t=>{t.content=this.core.replaceDelimitersWithTokens(t.content)};this.editor.on("BeforeSetContent",e),this.editor.on("PastePreProcess",e),this.editor.on("init",()=>{const t=this.editor.getBody();this._bodyClickHandler=s=>this.core.onBodyClick(s),t.addEventListener("click",this._bodyClickHandler)}),this.editor.on("remove",()=>{const t=this.editor.getBody();this._bodyClickHandler&&t.removeEventListener("click",this._bodyClickHandler)})}}class y{constructor(e,t){this.editor=e,this.core=t,this.tokens=t.state.tokens}mount(){this.editor.ui.registry.addIcon("mergetags",'<svg width="24" height="24" focusable="false"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5a2 2 0 0 1 1.6.8L21 12l-4.4 6.2a2 2 0 0 1-1.6.8h-3v-2h3l3.5-5L15 7H5v3H3V7c0-1.1.9-2 2-2h10Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0-1 1v2H3a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2H7v-2c0-.6-.4-1-1-1Z"></path></svg>'),this.editor.ui.registry.addMenuButton("mergetags",{icon:"mergetags",tooltip:"Insert merge tag",fetch:t=>t(this.core.getMenuItems())}),this.editor.ui.registry.addNestedMenuItem("mergetags-menu",{text:"Merge tags",getSubmenuItems:()=>this.core.getMenuItems()});const e={trigger:"{{",minChars:0,columns:1,matches:()=>!0,fetch:(t,s)=>Promise.resolve(this.tokens.autocomplete(t,s)),onAction:(t,s,r)=>{s&&this.editor.selection.setRng(s),this.core.insertByValue(String(r)),t.hide()}};this.editor.ui.registry.addAutocompleter("mergetags",e)}}class T{constructor(e){this.editor=e}register(){const{register:e}=this.editor.options;e("mergetags_list",{processor:"array",default:[]}),e("mergetags_prefix",{processor:"string",default:"{{"}),e("mergetags_suffix",{processor:"string",default:"}}"}),e("mergetags_token_class",{processor:"string",default:"mce-mergetag"}),e("mergetags_brace_class",{processor:"string",default:"mce-mergetag-affix"}),e("mergetags_highlight_class",{processor:"string",default:"mt-active"}),e("mergetags_show_braces",{processor:"boolean",default:!0}),e("mergetags_highlight_on_insert",{processor:"boolean",default:!0}),e("mergetags_display",{processor:"string",default:"value"}),e("mergetags_keep_unknown",{processor:"boolean",default:!0})}getPrefix(){return this.editor.options.get("mergetags_prefix")}getSuffix(){return this.editor.options.get("mergetags_suffix")}getTokenClass(){return this.editor.options.get("mergetags_token_class")}getBraceClass(){return this.editor.options.get("mergetags_brace_class")}getActiveClass(){return this.editor.options.get("mergetags_highlight_class")}getDisplayMode(){return this.editor.options.get("mergetags_display")}highlightOnInsert(){return!!this.editor.options.get("mergetags_highlight_on_insert")}keepUnknown(){return!!this.editor.options.get("mergetags_keep_unknown")}getList(){return this.editor.options.get("mergetags_list")}}const u=n=>{n.PluginManager.add("mergetags",e=>{const t=new T(e);t.register();const s=new k(e,t),r=new y(e,s),i=new v(e,s);return r.mount(),i.bindAll(),{getMetadata:()=>({name:"Merge Tags (Self-hosted)",version:"1.0.0"})}})};return(()=>{const n=typeof window<"u"&&window.tinymce?window.tinymce:null;n&&u(n)})(),h.registerMergetags=u,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"}),h}({});
