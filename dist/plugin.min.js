var mergetags=function(l){"use strict";class a{#e=[];#t=[];#s=new Map;static normalizeGroups(e){return Array.isArray(e)?e.map(t=>{const s=t?.menu??t?.items;return Array.isArray(s)?{title:String(t?.title??""),menu:a.normalizeGroups(s)}:typeof t?.value<"u"?{title:String(t?.title??t.value),value:String(t.value)}:null}).filter(Boolean):[]}static flatten(e,t=[]){for(const s of e)Array.isArray(s?.menu)?a.flatten(s.menu,t):typeof s?.value<"u"&&t.push({title:String(s.title??s.value),value:String(s.value)});return t}setTokens(e){this.#e=a.normalizeGroups(e??[]),this.#r()}refreshFromOptions(e){this.setTokens(e?.getList?.())}#r(){this.#t=a.flatten(this.#e,[]),this.#s=new Map(this.#t.map(e=>[e.value,e]))}autocomplete(e,t){const s=(e||"").toLowerCase(),r=this.#t,n=s?r.filter(o=>(o.title||o.value).toLowerCase().includes(s)||o.value.toLowerCase().includes(s)):r.slice(),y=Math.min(typeof t=="number"?t:10,n.length);return n.slice(0,y).map(o=>({text:o.title||o.value,value:o.value}))}getGroups(){return this.#e}getByValue(e){return this.#s.get(String(e))}}class g{constructor(e){this.options=e,this.tokens=new a}refreshFromOptions=()=>{this.tokens.refreshFromOptions(this.options)};setTokens=e=>{this.tokens.setTokens(e)}}const c=i=>String(i).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");class h{constructor(e){this.displayMode=e.getDisplayMode(),this.tokenClass=e.getTokenClass(),this.braceClass=e.getBraceClass(),this.prefix=e.getPrefix(),this.suffix=e.getSuffix()}#e(e){return this.displayMode==="value"?e.value:e.title||e.value}createTokenElement(e){const t=document.createElement("span");t.setAttribute("class",this.tokenClass),t.setAttribute("data-mt-val",e.value),t.setAttribute("contenteditable","false");const s=document.createElement("span");s.setAttribute("class",this.braceClass),s.textContent=this.prefix;const r=document.createTextNode(this.#e(e)),n=document.createElement("span");return n.setAttribute("class",this.braceClass),n.textContent=this.suffix,t.append(s,r,n),t}toSpanHTML(e,t){return this.createTokenElement(e,t).outerHTML}getDelimiterRegex(e="g"){const t=c(this.prefix),s=c(this.suffix);return new RegExp(`${t}([\\s\\S]*?)${s}`,e)}wrap(e){return`${this.prefix}${String(e)}${this.suffix}`}}class d{constructor(e,t,s){this.tokenClass=e.getTokenClass(),this.renderer=t,this.getByValue=s.getByValue.bind(s)}replaceTokensWithDelimiters(e){const t=document.createElement("div");t.innerHTML=e;for(const s of t.querySelectorAll(`span.${this.tokenClass}[data-mt-val]`)){const r=s.getAttribute("data-mt-val")||"";s.replaceWith(document.createTextNode(this.renderer.wrap(r)))}return t.innerHTML}replaceDelimitersWithTokens(e){const t=this.renderer.getDelimiterRegex("g");return e.replace(t,(s,r)=>{const n=this.getByValue(String(r));return n?this.renderer.toSpanHTML(n):s})}}class m{constructor(e,t,s,r){this.editor=e,this.tokenClass=t.getTokenClass(),this.activeClass=t.getActiveClass(),this.createTokenElement=s.createTokenElement.bind(s),this.getByValue=r.getByValue.bind(r)}clearActiveTokens(){const e=this.editor.getBody(),{tokenClass:t,activeClass:s}=this;e.querySelectorAll(`.${t}.${s}`).forEach(r=>r.classList.remove(s))}activateToken(e){this.clearActiveTokens(),e.classList.add(this.activeClass),this.editor.selection.select(e),this.editor.selection.collapse(!1)}insertTag(e){this.editor.undoManager.transact(()=>{const t=this.createTokenElement(e);this.editor.selection.setNode(t)})}insertByValue(e){const t=this.getByValue(e);t&&this.insertTag(t)}getTokenAncestor(e){return this.editor.dom.getParent(e,t=>t&&t.nodeType===1&&this.editor.dom.hasClass(t,this.tokenClass))}onContainerClick(e){const t=this.getTokenAncestor(e.target);if(!t)return this.clearActiveTokens();e.preventDefault(),this.activateToken(t)}}class f{constructor(e,t){this.state=new g(t),this.renderer=new h(t),this.transformer=new d(t,this.renderer,this.state.tokens),this.interactions=new m(e,t,this.renderer,this.state.tokens),this.state.refreshFromOptions()}insertByValue(e){this.interactions.insertByValue(e)}setTokens(e){this.state.setTokens(e)}replaceTokensWithDelimiters(e){return this.transformer.replaceTokensWithDelimiters(e)}replaceDelimitersWithTokens(e){return this.transformer.replaceDelimitersWithTokens(e)}onContainerClick(e){this.interactions.onContainerClick(e)}}class p{constructor(e,t){this.editor=e,this.core=t,this.containerClickHandler=null}bindAll(){this.editor.on("GetContent",t=>{t.content=this.core.replaceTokensWithDelimiters(t.content)});const e=t=>{t.content=this.core.replaceDelimitersWithTokens(t.content)};this.editor.on("BeforeSetContent",e),this.editor.on("PastePreProcess",e),this.editor.on("init",()=>{const t=this.editor.getContainer();this.containerClickHandler=s=>this.core.onContainerClick(s),t.addEventListener("click",this.containerClickHandler)}),this.editor.on("remove",()=>{const t=this.editor.getContainer();this.containerClickHandler&&t.removeEventListener("click",this.containerClickHandler)})}}class k{constructor(e,t){this.editor=e,this.core=t,this.tokens=t.state.tokens,this.interactions=t.interactions}mount(){const e=s=>!Array.isArray(s)||!s.length?[{type:"menuitem",text:"No tags",enabled:!1}]:s.map(r=>Array.isArray(r.menu)?{type:"nestedmenuitem",text:r.title||"",getSubmenuItems:()=>e(r.menu)}:{type:"menuitem",text:r.title||r.value,onAction:()=>this.interactions.insertTag({title:r.title||r.value,value:r.value})}),t={trigger:this.core.renderer.prefix,minChars:0,columns:1,matches:()=>!0,fetch:(s,r)=>Promise.resolve(this.tokens.autocomplete(s,r)),onAction:(s,r,n)=>{r&&this.editor.selection.setRng(r),this.core.insertByValue(String(n)),s.hide()}};this.editor.ui.registry.addIcon("mergetags",'<svg width="24" height="24" focusable="false"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5a2 2 0 0 1 1.6.8L21 12l-4.4 6.2a2 2 0 0 1-1.6.8h-3v-2h3l3.5-5L15 7H5v3H3V7c0-1.1.9-2 2-2h10Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0-1 1v2H3a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2H7v-2c0-.6-.4-1-1-1Z"></path></svg>'),this.editor.ui.registry.addMenuButton("mergetags",{icon:"mergetags",tooltip:"Insert merge tag",fetch:s=>s(e(this.tokens.getGroups()))}),this.editor.ui.registry.addNestedMenuItem("mergetags-menu",{text:"Merge tags",getSubmenuItems:()=>e(this.tokens.getGroups())}),this.editor.ui.registry.addAutocompleter("mergetags",t)}}class v{constructor(e){this.editor=e}register(){const{register:e}=this.editor.options;e("mergetags_prefix",{processor:"string",default:"{{"}),e("mergetags_suffix",{processor:"string",default:"}}"}),e("mergetags_token_class",{processor:"string",default:"mce-mergetag"}),e("mergetags_brace_class",{processor:"string",default:"mce-mergetag-affix"}),e("mergetags_highlight_class",{processor:"string",default:"mt-active"}),e("mergetags_display",{processor:"string",default:"value"}),e("mergetags_keep_unknown",{processor:"boolean",default:!0}),e("mergetags_list",{processor:"array",default:[]})}getPrefix(){return this.editor.options.get("mergetags_prefix")}getSuffix(){return this.editor.options.get("mergetags_suffix")}getTokenClass(){return this.editor.options.get("mergetags_token_class")}getBraceClass(){return this.editor.options.get("mergetags_brace_class")}getActiveClass(){return this.editor.options.get("mergetags_highlight_class")}getDisplayMode(){return this.editor.options.get("mergetags_display")}keepUnknown(){return!!this.editor.options.get("mergetags_keep_unknown")}getList(){return this.editor.options.get("mergetags_list")}}const u=i=>{i.PluginManager.add("mergetags",e=>{const t=new v(e);t.register();const s=new f(e,t),r=new k(e,s),n=new p(e,s);return r.mount(),n.bindAll(),{getMetadata:()=>({name:"Merge Tags (Self-hosted)",version:"1.0.0"})}})};return(()=>{const i=typeof window<"u"&&window.tinymce?window.tinymce:null;i&&u(i)})(),l.registerMergetags=u,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"}),l}({});
