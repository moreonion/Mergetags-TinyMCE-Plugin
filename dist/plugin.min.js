var mergetags=function(k){"use strict";const I=(e,t,s,i)=>{e.on("PreInit",s.refreshFromOptions),e.on("GetContent",o=>{o.content=i.replaceTokensWithDelimiters(o.content)});const l=o=>{o.content=i.replaceDelimitersWithTokens(o.content)};e.on("BeforeSetContent",l),e.on("PastePreProcess",l),e.on("keydown",o=>{const u=e.selection?.getNode(),v=i.getTokenAncestor(u);v&&(o.preventDefault(),e.undoManager.transact(()=>v.remove()))}),e.on("NodeChange",o=>{const u=i.getTokenAncestor(o.element);e.selection.select(u),e.selection.collapse(!1)});let g=null;e.on("init",()=>{const o=e.getBody();g=u=>i.onBodyClick(u),o.addEventListener("click",g),setTimeout(i.transformInitialContentOnce,0)}),e.on("LoadContent",i.transformInitialContentOnce),e.on("remove",()=>{e.getBody().removeEventListener("click",g)}),e.on("PreInit",()=>{e.schema.addValidElements("span[class|contenteditable|data-mt-val|data-mt-uid]");const o=t.getTokenClass(),u=t.getActiveClass(),v=t.getBraceClass();e.contentStyles.push(`.${o} .${v}{color:#16a34a;font-weight:400;}`,`.${o}.${u}{outline:3px solid rgba(0,125,126,.75);}`)})},P=(e,t,s)=>{e.addCommand("mergetags:insert",(i,l)=>{const g=l&&(l.value||l),o=t.map.get(String(g));s.insertTag(o)}),e.addCommand("mergetags:setTokens",(i,l)=>{t.setTokens(l);const g=e.getContent({format:"html"}),o=s.replaceDelimitersWithTokens(g);e.setContent(o),s.migrateOldTokens()})},N=e=>{const t=e.options.register;t("mergetags_list",{processor:"array",default:[]}),t("mergetags_prefix",{processor:"string",default:"{{"}),t("mergetags_suffix",{processor:"string",default:"}}"}),t("mergetags_trigger",{processor:"string",default:"{{"}),t("mergetags_max_suggestions",{processor:"number",default:100}),t("mergetags_token_class",{processor:"string",default:"mce-mergetag"}),t("mergetags_brace_class",{processor:"string",default:"mce-mergetag-affix"}),t("mergetags_highlight_class",{processor:"string",default:"mt-active"}),t("mergetags_show_braces",{processor:"boolean",default:!0}),t("mergetags_highlight_on_insert",{processor:"boolean",default:!0}),t("mergetags_display",{processor:"string",default:"value"}),t("mergetags_keep_unknown",{processor:"boolean",default:!0})},D=e=>({getPrefix:()=>e.options.get("mergetags_prefix"),getSuffix:()=>e.options.get("mergetags_suffix"),getTrigger:()=>e.options.get("mergetags_trigger")||"{{",getMaxSuggestions:()=>Number(e.options.get("mergetags_max_suggestions")),getTokenClass:()=>e.options.get("mergetags_token_class"),getBraceClass:()=>e.options.get("mergetags_brace_class"),getActiveClass:()=>e.options.get("mergetags_highlight_class"),getDisplayMode:()=>e.options.get("mergetags_display"),showBraces:()=>e.options.get("mergetags_show_braces")}),b=e=>Array.isArray(e)?e.map(t=>{const s=t.menu||t.items;return Array.isArray(s)?{title:String(t.title||""),menu:b(s)}:typeof t.value<"u"?{title:String(t.title||t.value),value:String(t.value)}:null}).filter(Boolean):[],S=(e,t=[])=>{for(const s of e)Array.isArray(s.menu)?S(s.menu,t):typeof s.value<"u"&&t.push({title:String(s.title||s.value),value:String(s.value)});return t},L=e=>{let t=[],s=[],i=new Map,l=0,g=!1;const o=()=>{s=S(t,[]),i=new Map(s.map(m=>[m.value,m]))};return{get grouped(){return t},get flat(){return s},get map(){return i},get didInitPass(){return g},set didInitPass(m){g=!!m},rebuildIndex:o,refreshFromOptions:()=>{const m=e.options.get("mergetags_list");t=b(m),o()},setTokens:m=>{t=b(m||[]),o()},nextUid:()=>(l+=1,l.toString(36))}},T=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),O=e=>String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),R=(e,t,s)=>{const i=n=>t.getDisplayMode()==="value"?n.value:n.title||n.value,l=(n,a)=>{const r=e.getDoc(),c=r.createElement("span");if(c.setAttribute("class",t.getTokenClass()),c.setAttribute("data-mt-val",n.value),a&&c.setAttribute("data-mt-uid",String(a)),c.setAttribute("contenteditable","false"),t.showBraces()){const f=r.createElement("span");f.setAttribute("class",t.getBraceClass()),f.textContent=t.getPrefix();const d=r.createTextNode(i(n)),p=r.createElement("span");p.setAttribute("class",t.getBraceClass()),p.textContent=t.getSuffix(),c.append(f,d,p)}else c.textContent=i(n);return c},g=(n,a)=>{const r=t.getTokenClass(),c=t.getBraceClass(),f=O(n.value),d=a?` data-mt-uid="${String(a)}"`:"";return t.showBraces()?`<span class="${r}" data-mt-val="${f}"${d} contenteditable="false"><span class="${c}">${e.dom.encode(t.getPrefix())}</span>${e.dom.encode(i(n))}<span class="${c}">${e.dom.encode(t.getSuffix())}</span></span>`:`<span class="${r}" data-mt-val="${f}"${d} contenteditable="false">${e.dom.encode(i(n))}</span>`},o=()=>{const n=e.getBody(),a=t.getTokenClass(),r=t.getActiveClass();n.querySelectorAll(`span.${a}.${r}`).forEach(c=>c.classList.remove(r))},u=n=>{o(),n.classList.add(t.getActiveClass()),e.selection.select(n),e.selection.collapse(!1)},v=n=>{e.undoManager.transact(()=>{const a=s.nextUid(),r=l(n,a);e.selection.setNode(r)})},C=n=>!Array.isArray(n)||!n.length?[{type:"menuitem",text:"No tags",enabled:!1}]:n.map(a=>Array.isArray(a.menu)?{type:"nestedmenuitem",text:a.title||"",getSubmenuItems:()=>C(a.menu)}:{type:"menuitem",text:a.title||a.value,onAction:()=>v({title:a.title||a.value,value:a.value})}),m=n=>{const a=document.implementation.createHTMLDocument(""),r=a.createElement("div");r.innerHTML=n;const c=t.getTokenClass(),f=t.getPrefix(),d=t.getSuffix();return r.querySelectorAll(`span.${c}[data-mt-val]`).forEach(p=>{const x=p.getAttribute("data-mt-val")||"";p.replaceWith(a.createTextNode(f+x+d))}),r.innerHTML},_=n=>{const a=t.getPrefix(),r=t.getSuffix(),c=new RegExp(`${T(a)}([\\s\\S]*?)${T(r)}`,"g");return n.replace(c,(f,d)=>{const p=s.map.get(String(d));return p?g(p):f})},E=()=>{const a=(e.selection?.getRng()).startContainer,r=a?.nodeType===Node.TEXT_NODE?a:[...a?.childNodes??[]].find(h=>h.nodeType===Node.TEXT_NODE);if(!r)return!1;const c=t.getPrefix(),f=t.getSuffix(),d=new RegExp(`${T(c)}([\\s\\S]*?)${T(f)}`),p=r.nodeValue,x=d.exec(p);if(!x)return!1;const U=String(x[1]),w=s.map.get(U);return w?(e.undoManager.transact(()=>{const h=p.slice(0,x.index),M=p.slice(x.index+x[0].length),y=r.parentNode,W=s.nextUid(),B=l(w,W);h&&y.insertBefore(e.getDoc().createTextNode(h),r),y.insertBefore(B,r),M&&y.insertBefore(e.getDoc().createTextNode(M),r),y.removeChild(r),u(B)}),!0):!1},$=()=>{const n=e.getBody();if(!n)return;const a=t.getTokenClass(),r=t.getBraceClass();n.querySelectorAll(`span.${a}[data-mt-val]`).forEach(c=>{if(c.querySelector(`span.${r}`))return;const f=c.getAttribute("data-mt-val")||"",d=s.map.get(f)||{title:f,value:f},p=s.nextUid(),x=l(d,p);c.replaceWith(x)})};return{createTokenElement:l,toSpanHTML:g,insertTag:v,buildMenuItems:C,replaceTokensWithDelimiters:m,replaceDelimitersWithTokens:_,upgradeRawUnderCaret:E,migrateOldTokens:$,transformInitialContentOnce:()=>{if(s.didInitPass)return;s.didInitPass=!0;const n=e.getContent({format:"html"}),a=_(n);a!==n&&e.setContent(a),$()},clearActiveTokens:o,activateToken:u,getTokenAncestor:n=>{const a=t.getTokenClass();return e.dom.getParent(n,r=>r&&r.nodeType===1&&e.dom.hasClass(r,a))},onBodyClick:n=>{const a=t.getTokenClass(),r=e.dom.getParent(n.target,c=>c&&c.nodeType===1&&e.dom.hasClass(c,a));if(r){n.preventDefault(),u(r);return}E()||o()}}},H=(e,t,s,i)=>{e.ui.registry.addIcon("mergetags",'<svg width="24" height="24" focusable="false"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 5a2 2 0 0 1 1.6.8L21 12l-4.4 6.2a2 2 0 0 1-1.6.8h-3v-2h3l3.5-5L15 7H5v3H3V7c0-1.1.9-2 2-2h10Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0-1 1v2H3a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2H7v-2c0-.6-.4-1-1-1Z"></path></svg>'),e.ui.registry.addMenuButton("mergetags",{icon:"mergetags",tooltip:"Insert merge tag",fetch:l=>l(i.buildMenuItems(s.grouped))}),e.ui.registry.addAutocompleter("mergetags",{trigger:t.getTrigger(),minChars:0,columns:1,matches:()=>!0,fetch:(l,g)=>{const o=(l||"").toLowerCase(),u=o?s.flat.filter(m=>m.title.toLowerCase().includes(o)||m.value.toLowerCase().includes(o)):s.flat.slice(),v=t.getMaxSuggestions(),C=Math.min(g||v,v);return Promise.resolve(u.slice(0,C).map(m=>({text:m.title,value:m.value})))},onAction:(l,g,o)=>{e.selection.setRng(g);const u=s.map.get(String(o))||{title:String(o),value:String(o)};i.insertTag(u),l.hide()}})},A=e=>{e.PluginManager.add("mergetags",t=>{N(t);const s=D(t),i=L(t),l=R(t,s,i);return H(t,s,i,l),I(t,s,i,l),P(t,i,l),{getMetadata:()=>({name:"Merge Tags (Self-hosted)",version:"1.0.0"})}})};return(()=>{const e=typeof window<"u"&&window.tinymce?window.tinymce:null;e&&A(e)})(),k.registerMergetags=A,Object.defineProperty(k,Symbol.toStringTag,{value:"Module"}),k}({});
